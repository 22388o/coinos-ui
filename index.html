<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bitcoin Payment Calculator</title>
    <script language="javascript" type="text/javascript" src="http://code.jquery.com/jquery-1.8.1.min.js"></script>
    <script language="javascript" type="text/javascript">
      $(function() {
        var websocket = new WebSocket("ws://api.blockchain.info:8335/inv");
        var exchange = 0;
        var total = 0;
        var received = 0;
        var address = getParameterByName('address');
        var qr_url = 'https://chart.googleapis.com/chart?cht=qr&chl=bitcoin:' + address + '&chs=177x177&chld=H'

        if (address == "")
          window.location = 'index.html?address=1SoLtySab29J2tAdF2x3PosjnwWF37wEY'

        $('#qr').attr('src', qr_url);
        $('#address').html(address);

        websocket.onopen = function() { 
          websocket.send('{"op":"addr_sub", "addr":"' + address + '"}');
        }

        websocket.onmessage = function(e) { 
          var results = eval('(' + e.data + ')');
          
          $.each(results.x.out, function(i, v) {
            if (v.addr == address) {
              received += v.value / 100000000;
            }
          });

          $.each(results.x.inputs, function(i, v) {
            if (v.prev_out.addr == address) {
              input -= v.prev_out.value / 100000000;
            }
          });

          $('#status').html('Received: ' + received.toString());
          if (total <= received) {
            $('#status').css('color', 'green');
          }
        }

        $.getJSON('ticker', function (data) {
          exchange = data.return.last.value;  
          $('#exchange').html(exchange);
          updateTotal();
        });

        $('#owing').keyup(updateTotal);
        $('#owing').focus();

        function updateTotal() {
          var owing = parseFloat($('#owing').val());
          total = owing / exchange;
          total = Math.ceil(total * 10000) / 10000;
          if (!$.isNumeric(total)) total = '';
          $('#total').html(total.toString());
        }
      });

      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(window.location.search);
        if(results == null)
          return "";
        else
          return decodeURIComponent(results[1].replace(/\+/g, " "));
      }
    </script>
  </head>
  <style>
    body, input { font-family: 'Arial'; font-size: 20px; }
    body { width: 100% }
    #container { width: 50%; margin: 0px auto; }
    #total { font-size: 32px; }
    #status { color: red }
  </style>
  <body>
    <div id="container">
      <div>
        $<input type="text" id="owing" value="0" size="4" /> CAD @
        <span id="exchange"></span>
        BTC/CAD
      </div>

      <br />

      <div>
        <span>Please send</span>
        <strong id="total">0.0</strong>
        bitcoins to:

        <br /><br />

        <span id="address"></span>

        <br />

        <img id="qr" src="" width="300" height="300" />
        
        <br />
        
        <span id="status">Waiting for Payment</span>
      </div>
    </div>
  </body>
</html> 
